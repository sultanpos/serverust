name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-pr:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get latest PR title
      id: pr-title
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          return pullRequest.title;
        result-encoding: string
    
    - name: Check PR title format
      env:
        PR_TITLE: ${{ steps.pr-title.outputs.result }}
      run: |
        echo "Checking PR title: $PR_TITLE"
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+ ]]; then
          echo "‚ùå PR title must follow conventional commits format"
          echo "Examples: 'feat: add user authentication' or 'fix(auth): resolve login issue'"
          exit 1
        fi
        echo "‚úÖ PR title format is valid: $PR_TITLE"
    
    - name: Check for breaking changes
      run: |
        # Check if there are breaking changes in the PR
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(Cargo.toml|src/.*\.rs)" > /dev/null; then
          echo "üîç Code changes detected - running full test suite"
          echo "run_full_tests=true" >> $GITHUB_ENV
        else
          echo "üìù Only documentation changes detected"
          echo "run_full_tests=false" >> $GITHUB_ENV
        fi
    
    - name: Comment on PR
      if: github.event.action == 'opened'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üöÄ Thanks for the PR! The CI pipeline will run tests for both SQLite and PostgreSQL databases. Please ensure all checks pass before requesting a review.'
          })

  validate-code:
    name: Code Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Check code formatting
      run: |
        if ! cargo fmt --all -- --check; then
          echo "‚ùå Code is not properly formatted"
          echo "Run 'cargo fmt' to fix formatting issues"
          exit 1
        fi
        echo "‚úÖ Code formatting is correct"
    
    - name: Run Clippy lints
      run: |
        if ! cargo clippy --all-targets --all-features -- -D warnings; then
          echo "‚ùå Clippy found issues"
          echo "Fix the issues shown above"
          exit 1
        fi
        echo "‚úÖ No Clippy issues found"
    
    - name: Check for TODO/FIXME comments
      run: |
        if grep -r "TODO\|FIXME" src/ --include="*.rs"; then
          echo "‚ö†Ô∏è  Found TODO/FIXME comments. Consider addressing them before merging."
        else
          echo "‚úÖ No TODO/FIXME comments found"
        fi
